<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-axis Labels Final Test</title>
    <!-- Force cache refresh with timestamp -->
    <script type="module" src="./packages/core/dist/siemens-ix/siemens-ix.esm.js?v=20250103"></script>
    <link rel="stylesheet" href="./packages/core/dist/siemens-ix/siemens-ix.css?v=20250103">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        .test-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-title {
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: bold;
            color: #01d65a;
        }
        .debug-info {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>StatusHistoryChart X-axis Label Alignment - Final Test</h1>

    <div class="test-container">
        <div class="test-title">✓ 修复后的标签对齐 (Fixed Label Alignment)</div>
        <ix-card>
            <ix-card-content>
                <ix-status-history-chart
                    chart-title="Status history"
                    data='{"Jan": {"online": 10, "maintenance": 0, "error": 0, "offline": -100}, "Feb": {"online": 5, "maintenance": -5, "error": 0, "offline": -40}, "Mar": {"online": -10, "maintenance": -60, "error": -20, "offline": -40}, "Apr": {"online": -25, "maintenance": -40, "error": -25, "offline": -80}, "May": {"online": 0, "maintenance": 0, "error": 0, "offline": -40}, "Jun": {"online": 0, "maintenance": 0, "error": 0, "offline": -40}}'>
                </ix-status-history-chart>
            </ix-card-content>
        </ix-card>
        <div class="debug-info" id="debug-info-1">Loading debug info...</div>
    </div>

    <div class="test-container">
        <div class="test-title">测试2：中文标签 (Chinese Labels)</div>
        <ix-card>
            <ix-card-content>
                <ix-status-history-chart
                    chart-title="系统状态历史"
                    data='{"一月": {"online": 10, "maintenance": 0, "error": -5, "offline": -80}, "二月": {"online": 5, "maintenance": -10, "error": -8, "offline": -60}, "三月": {"online": -5, "maintenance": -30, "error": -20, "offline": -50}, "四月": {"online": 0, "maintenance": -20, "error": -10, "offline": -70}, "五月": {"online": 8, "maintenance": -5, "error": -3, "offline": -40}, "六月": {"online": 12, "maintenance": 0, "error": -2, "offline": -35}}'>
                </ix-status-history-chart>
            </ix-card-content>
        </ix-card>
        <div class="debug-info" id="debug-info-2">Loading debug info...</div>
    </div>

    <script>
        // Force refresh and check alignment
        setTimeout(() => {
            console.log('=== X-axis Label Alignment Final Test ===');

            document.querySelectorAll('ix-status-history-chart').forEach((chart, chartIndex) => {
                console.log(`\nChart ${chartIndex + 1}:`);

                if (chart.shadowRoot) {
                    const xLabels = chart.shadowRoot.querySelectorAll('.x-label');
                    const verticalLines = chart.shadowRoot.querySelectorAll('.grid-lines line[x1]');
                    const chartSvg = chart.shadowRoot.querySelector('.chart-svg-container');

                    let debugInfo = `Chart ${chartIndex + 1} Debug:\n`;

                    if (chartSvg) {
                        const svgRect = chartSvg.getBoundingClientRect();

                        xLabels.forEach((label, index) => {
                            const labelRect = label.getBoundingClientRect();
                            const labelText = label.textContent?.trim();
                            const labelStyle = label.getAttribute('style');

                            // Parse the transform and left values from style
                            const leftMatch = labelStyle?.match(/left:\s*([^;]+)/);
                            const transformMatch = labelStyle?.match(/transform:\s*([^;]+)/);

                            const leftValue = leftMatch ? leftMatch[1] : 'unknown';
                            const transformValue = transformMatch ? transformMatch[1] : 'unknown';

                            debugInfo += `Label "${labelText}": left=${leftValue}, transform=${transformValue}\n`;

                            // Get corresponding vertical line position
                            if (verticalLines[index]) {
                                const x1 = parseFloat(verticalLines[index].getAttribute('x1'));
                                const gridLineX = svgRect.left + x1;
                                const labelCenter = labelRect.left + labelRect.width / 2;
                                const offset = Math.abs(labelCenter - gridLineX);

                                debugInfo += `  Grid line at: ${x1}px, Label center offset: ${offset.toFixed(1)}px\n`;

                                console.log(`  Label "${labelText}": left=${leftValue}, transform=${transformValue}, offset=${offset.toFixed(1)}px`);
                            }
                        });
                    }

                    // Update debug info in the page
                    const debugElement = document.getElementById(`debug-info-${chartIndex + 1}`);
                    if (debugElement) {
                        debugElement.textContent = debugInfo;
                    }
                }
            });
        }, 1500);

        // Also check if the component is properly loaded
        setTimeout(() => {
            const charts = document.querySelectorAll('ix-status-history-chart');
            console.log(`Found ${charts.length} charts`);
            charts.forEach((chart, index) => {
                console.log(`Chart ${index + 1} shadow root:`, chart.shadowRoot ? 'exists' : 'missing');
            });
        }, 500);
    </script>
</body>
</html>
