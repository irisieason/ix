<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Flicker Test</title>
    <script type="module" src="./packages/core/dist/siemens-ix/siemens-ix.esm.js"></script>
    <link rel="stylesheet" href="./packages/core/dist/siemens-ix/siemens-ix.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            /* 防止整个页面闪烁 */
            opacity: 1;
            visibility: visible;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            /* 确保容器稳定 */
            min-height: 100vh;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            /* 防止测试区域闪烁 */
            opacity: 1;
            visibility: visible;
        }
        .card-wrapper {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #555;
            border-radius: 8px;
            /* 确保包装器稳定 */
            min-height: 400px;
            align-items: center;
        }
        .status-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #007acc;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
        }
        .flicker-detector {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #ff2640;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        .flicker-detector.active {
            display: block;
        }
        .resize-instructions {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="status-info" id="status-info">
        窗口尺寸: <span id="window-size">0x0</span><br>
        卡片尺寸: <span id="card-size">测量中...</span><br>
        闪烁次数: <span id="flicker-count">0</span>
    </div>

    <div class="flicker-detector" id="flicker-detector">
        ⚠️ 检测到闪烁！
    </div>

    <div class="container">
        <h1>防闪烁测试</h1>

        <div class="resize-instructions">
            <strong>测试说明：</strong><br>
            1. 拖拽浏览器窗口边缘调整大小<br>
            2. 观察卡片是否出现闪烁或变白<br>
            3. 右上角显示实时状态信息<br>
            4. 如果检测到闪烁，左上角会显示警告
        </div>

        <div class="test-section">
            <h2>单个卡片测试</h2>
            <div class="card-wrapper">
                <ix-custom-card id="test-card"></ix-custom-card>
            </div>
        </div>

        <div class="test-section">
            <h2>多个卡片测试</h2>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <ix-custom-card card-title="Card 1"></ix-custom-card>
                <ix-custom-card card-title="Card 2"></ix-custom-card>
                <ix-custom-card card-title="Card 3"></ix-custom-card>
            </div>
        </div>

        <div class="test-section">
            <h2>网格布局测试</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <ix-custom-card card-title="Grid 1"></ix-custom-card>
                <ix-custom-card card-title="Grid 2"></ix-custom-card>
                <ix-custom-card card-title="Grid 3"></ix-custom-card>
                <ix-custom-card card-title="Grid 4"></ix-custom-card>
            </div>
        </div>
    </div>

    <script>
        let flickerCount = 0;
        let lastCardSize = null;
        let resizeTimeout = null;

        function updateStatus() {
            const windowSize = `${window.innerWidth}x${window.innerHeight}`;
            document.getElementById('window-size').textContent = windowSize;

            const testCard = document.getElementById('test-card');
            if (testCard) {
                const rect = testCard.getBoundingClientRect();
                const currentSize = `${Math.round(rect.width)}x${Math.round(rect.height)}`;
                document.getElementById('card-size').textContent = currentSize;

                // 检测异常的尺寸变化（可能表示闪烁）
                if (lastCardSize && lastCardSize !== currentSize) {
                    const [lastW, lastH] = lastCardSize.split('x').map(Number);
                    const [currW, currH] = currentSize.split('x').map(Number);

                    // 如果尺寸突然变为0或异常小，可能是闪烁
                    if (currW < 100 || currH < 100 || (lastW > 400 && currW < 200)) {
                        flickerCount++;
                        document.getElementById('flicker-count').textContent = flickerCount;
                        showFlickerWarning();
                    }
                }

                lastCardSize = currentSize;
            }
        }

        function showFlickerWarning() {
            const detector = document.getElementById('flicker-detector');
            detector.classList.add('active');
            setTimeout(() => {
                detector.classList.remove('active');
            }, 2000);
        }

        // 监听窗口大小变化
        window.addEventListener('resize', () => {
            // 清除之前的超时
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }

            // 立即更新状态
            updateStatus();

            // 延迟检查，确保组件已经完成调整
            resizeTimeout = setTimeout(() => {
                updateStatus();
            }, 100);
        });

        // 监听组件加载
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('=== No Flicker Test ===');
                updateStatus();

                // 定期检查状态
                setInterval(updateStatus, 500);

                // 检查所有卡片
                const cards = document.querySelectorAll('ix-custom-card');
                console.log('Cards loaded:', cards.length);

                cards.forEach((card, index) => {
                    const rect = card.getBoundingClientRect();
                    console.log(`Card ${index + 1}:`, {
                        width: Math.round(rect.width),
                        height: Math.round(rect.height),
                        visible: rect.width > 0 && rect.height > 0
                    });
                });
            }, 1000);
        });

        // 监听可见性变化（可能表示闪烁）
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                setTimeout(updateStatus, 100);
            }
        });
    </script>
</body>
</html>
