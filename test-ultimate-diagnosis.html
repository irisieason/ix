<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Diagnosis - Deep Investigation</title>
    <script type="module" src="./packages/core/dist/siemens-ix/siemens-ix.esm.js"></script>
    <link rel="stylesheet" href="./packages/core/dist/siemens-ix/siemens-ix.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: white;
            text-align: center;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .card-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #555;
            border-radius: 8px;
        }
        .debug-info {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            margin: 20px 0;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .manual-test {
            background: #2d4a2d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .manual-bar {
            height: 16px;
            margin: 5px 0;
            display: block;
        }
        .success { background-color: #01d65a; }
        .warning { background-color: #ffd732; }
        .alarm { background-color: #ff2640; }
        .critical { background-color: #ff9000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>终极诊断：深度调查 Bar Chart 问题</h1>

        <div class="manual-test">
            <h3>手动测试：这些颜色在普通 HTML 中是否可见？</h3>
            <div class="manual-bar success" style="width: 60px;">绿色 #01d65a</div>
            <div class="manual-bar warning" style="width: 80px;">黄色 #ffd732</div>
            <div class="manual-bar alarm" style="width: 40px;">红色 #ff2640</div>
            <div class="manual-bar critical" style="width: 50px;">橙色 #ff9000</div>
        </div>

        <div class="test-section">
            <h2>组件显示</h2>
            <div class="card-container">
                <ix-custom-card id="test-card"></ix-custom-card>
            </div>
        </div>

        <div class="test-section">
            <h2>1. Shadow DOM 完整结构</h2>
            <div class="debug-info" id="shadow-structure">
                分析中...
            </div>
        </div>

        <div class="test-section">
            <h2>2. 样式表分析</h2>
            <div class="debug-info" id="stylesheet-analysis">
                分析中...
            </div>
        </div>

        <div class="test-section">
            <h2>3. 元素计算样式</h2>
            <div class="debug-info" id="computed-styles">
                分析中...
            </div>
        </div>

        <div class="test-section">
            <h2>4. 可能的根本原因</h2>
            <div class="debug-info" id="root-causes">
                分析中...
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('=== Ultimate Diagnosis Started ===');

                const card = document.getElementById('test-card');

                if (!card) {
                    document.getElementById('shadow-structure').textContent = '❌ 组件元素未找到';
                    return;
                }

                if (!card.shadowRoot) {
                    document.getElementById('shadow-structure').textContent = '❌ Shadow DOM 未找到';
                    return;
                }

                const shadowRoot = card.shadowRoot;

                // 1. Shadow DOM 完整结构分析
                let structureInfo = '=== Shadow DOM 完整结构 ===\n\n';

                function analyzeElement(element, indent = '') {
                    let info = '';
                    if (element.nodeType === Node.ELEMENT_NODE) {
                        const tagName = element.tagName.toLowerCase();
                        const className = element.className || '';
                        const id = element.id || '';
                        const style = element.getAttribute('style') || '';

                        info += `${indent}<${tagName}`;
                        if (id) info += ` id="${id}"`;
                        if (className) info += ` class="${className}"`;
                        if (style) info += ` style="${style}"`;
                        info += '>\n';

                        // 递归分析子元素
                        for (let child of element.children) {
                            info += analyzeElement(child, indent + '  ');
                        }

                        info += `${indent}</${tagName}>\n`;
                    }
                    return info;
                }

                // 分析整个 shadow DOM
                for (let child of shadowRoot.children) {
                    structureInfo += analyzeElement(child);
                }

                document.getElementById('shadow-structure').textContent = structureInfo;

                // 2. 样式表分析
                let stylesheetInfo = '=== Shadow DOM 样式表分析 ===\n\n';

                const stylesheets = shadowRoot.styleSheets;
                stylesheetInfo += `样式表数量: ${stylesheets.length}\n\n`;

                for (let i = 0; i < stylesheets.length; i++) {
                    const sheet = stylesheets[i];
                    stylesheetInfo += `样式表 ${i + 1}:\n`;
                    stylesheetInfo += `  href: ${sheet.href || 'inline'}\n`;
                    stylesheetInfo += `  rules: ${sheet.cssRules ? sheet.cssRules.length : 'N/A'}\n`;

                    if (sheet.cssRules) {
                        // 查找与 bar 相关的规则
                        for (let j = 0; j < sheet.cssRules.length; j++) {
                            const rule = sheet.cssRules[j];
                            if (rule.selectorText && (
                                rule.selectorText.includes('.bar-') ||
                                rule.selectorText.includes('.chart-') ||
                                rule.selectorText.includes('.success') ||
                                rule.selectorText.includes('.warning') ||
                                rule.selectorText.includes('.alarm') ||
                                rule.selectorText.includes('.critical')
                            )) {
                                stylesheetInfo += `    规则: ${rule.selectorText}\n`;
                                stylesheetInfo += `      样式: ${rule.style.cssText}\n`;
                            }
                        }
                    }
                    stylesheetInfo += '\n';
                }

                document.getElementById('stylesheet-analysis').textContent = stylesheetInfo;

                // 3. 元素计算样式分析
                let stylesInfo = '=== 关键元素计算样式 ===\n\n';

                // 查找所有可能的 bar 元素
                const barElements = [
                    ...shadowRoot.querySelectorAll('.bar-success'),
                    ...shadowRoot.querySelectorAll('.bar-warning'),
                    ...shadowRoot.querySelectorAll('.bar-alarm'),
                    ...shadowRoot.querySelectorAll('.bar-critical'),
                    ...shadowRoot.querySelectorAll('.bar'), // 旧的类名
                ];

                stylesInfo += `找到的 bar 元素: ${barElements.length} 个\n\n`;

                barElements.forEach((bar, index) => {
                    const style = window.getComputedStyle(bar);
                    stylesInfo += `Bar ${index + 1} (${bar.className}):\n`;
                    stylesInfo += `  display: ${style.display}\n`;
                    stylesInfo += `  width: ${style.width}\n`;
                    stylesInfo += `  height: ${style.height}\n`;
                    stylesInfo += `  background-color: ${style.backgroundColor}\n`;
                    stylesInfo += `  background: ${style.background}\n`;
                    stylesInfo += `  opacity: ${style.opacity}\n`;
                    stylesInfo += `  visibility: ${style.visibility}\n`;
                    stylesInfo += `  position: ${style.position}\n`;
                    stylesInfo += `  z-index: ${style.zIndex}\n`;
                    stylesInfo += `  overflow: ${style.overflow}\n`;
                    stylesInfo += `  border: ${style.border}\n`;
                    stylesInfo += `  margin: ${style.margin}\n`;
                    stylesInfo += `  padding: ${style.padding}\n`;
                    stylesInfo += `  box-sizing: ${style.boxSizing}\n`;
                    stylesInfo += `  transform: ${style.transform}\n`;
                    stylesInfo += `  clip: ${style.clip}\n`;
                    stylesInfo += `  clip-path: ${style.clipPath}\n`;
                    stylesInfo += '\n';
                });

                // 检查容器元素
                const containers = [
                    shadowRoot.querySelector('.chart-container'),
                    shadowRoot.querySelector('.chart-area'),
                    shadowRoot.querySelector('.bar-chart'),
                    ...shadowRoot.querySelectorAll('.chart-row')
                ];

                containers.forEach((container, index) => {
                    if (container) {
                        const style = window.getComputedStyle(container);
                        stylesInfo += `容器 ${index + 1} (${container.className}):\n`;
                        stylesInfo += `  display: ${style.display}\n`;
                        stylesInfo += `  width: ${style.width}\n`;
                        stylesInfo += `  height: ${style.height}\n`;
                        stylesInfo += `  position: ${style.position}\n`;
                        stylesInfo += `  overflow: ${style.overflow}\n`;
                        stylesInfo += `  background: ${style.background}\n`;
                        stylesInfo += '\n';
                    }
                });

                document.getElementById('computed-styles').textContent = stylesInfo;

                // 4. 根本原因分析
                let causesInfo = '=== 根本原因分析 ===\n\n';

                const issues = [];

                // 检查 bar 元素是否存在
                if (barElements.length === 0) {
                    issues.push('❌ 致命问题：没有找到任何 bar 元素');
                    issues.push('   可能原因：');
                    issues.push('   - TSX 模板渲染失败');
                    issues.push('   - 类名不匹配');
                    issues.push('   - 条件渲染问题');
                } else {
                    issues.push(`✅ 找到 ${barElements.length} 个 bar 元素`);

                    // 检查每个 bar 的问题
                    let visibleBars = 0;
                    barElements.forEach((bar, index) => {
                        const style = window.getComputedStyle(bar);
                        const problems = [];

                        if (style.display === 'none') problems.push('display: none');
                        if (style.visibility === 'hidden') problems.push('visibility: hidden');
                        if (parseFloat(style.opacity) === 0) problems.push('opacity: 0');
                        if (parseInt(style.width) <= 0) problems.push('width <= 0');
                        if (parseInt(style.height) <= 0) problems.push('height <= 0');
                        if (style.backgroundColor === 'rgba(0, 0, 0, 0)' || style.backgroundColor === 'transparent') {
                            problems.push('背景色透明');
                        }
                        if (style.position === 'absolute' && (style.left === 'auto' || style.top === 'auto')) {
                            problems.push('绝对定位但位置未设置');
                        }
                        if (style.overflow === 'hidden' && (parseInt(style.width) === 0 || parseInt(style.height) === 0)) {
                            problems.push('overflow hidden 且尺寸为0');
                        }

                        if (problems.length === 0) {
                            visibleBars++;
                        } else {
                            issues.push(`❌ Bar ${index + 1} 问题: ${problems.join(', ')}`);
                        }
                    });

                    issues.push(`可见的 bars: ${visibleBars}/${barElements.length}`);
                }

                // 检查样式表问题
                if (stylesheets.length === 0) {
                    issues.push('❌ 没有找到样式表');
                } else {
                    let hasBarStyles = false;
                    for (let i = 0; i < stylesheets.length; i++) {
                        const sheet = stylesheets[i];
                        if (sheet.cssRules) {
                            for (let j = 0; j < sheet.cssRules.length; j++) {
                                const rule = sheet.cssRules[j];
                                if (rule.selectorText && rule.selectorText.includes('.bar-')) {
                                    hasBarStyles = true;
                                    break;
                                }
                            }
                        }
                    }

                    if (!hasBarStyles) {
                        issues.push('❌ 样式表中没有找到 .bar- 相关的样式规则');
                    } else {
                        issues.push('✅ 找到了 bar 相关的样式规则');
                    }
                }

                causesInfo += issues.join('\n') + '\n\n';

                causesInfo += '=== 建议的解决方案 ===\n';
                if (barElements.length === 0) {
                    causesInfo += '1. 检查 TSX 模板是否正确渲染\n';
                    causesInfo += '2. 验证组件是否正确编译\n';
                    causesInfo += '3. 检查条件渲染逻辑\n';
                } else if (visibleBars === 0) {
                    causesInfo += '1. 使用内联样式强制设置样式\n';
                    causesInfo += '2. 检查 CSS 变量是否正确定义\n';
                    causesInfo += '3. 考虑使用 SVG 或 Canvas\n';
                    causesInfo += '4. 检查 Shadow DOM 样式隔离问题\n';
                } else {
                    causesInfo += '部分 bars 可见，检查不可见的 bars 的具体问题\n';
                }

                document.getElementById('root-causes').textContent = causesInfo;

                console.log('Ultimate Diagnosis Complete:', {
                    barElements: barElements.length,
                    visibleBars: visibleBars,
                    stylesheets: stylesheets.length,
                    issues: issues
                });
            }, 2000);
        });
    </script>
</body>
</html>
