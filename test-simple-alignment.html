<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Alignment Test</title>
    <script type="module" src="./packages/core/dist/siemens-ix/siemens-ix.esm.js"></script>
    <link rel="stylesheet" href="./packages/core/dist/siemens-ix/siemens-ix.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        .debug-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
        }
        .debug-line {
            position: absolute;
            width: 2px;
            height: 100%;
            opacity: 0.8;
        }
        .grid-line { background: green; }
        .label-line { background: red; }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container" style="position: relative;">
        <h2>StatusHistoryChart 标签对齐测试</h2>

        <div class="debug-overlay" id="debug-overlay"></div>

        <ix-status-history-chart
            chart-title="测试图表"
            data='{"Jan": {"online": 10, "maintenance": 0, "error": 0, "offline": -100}, "Feb": {"online": 5, "maintenance": -5, "error": 0, "offline": -40}, "Mar": {"online": -10, "maintenance": -60, "error": -20, "offline": -40}}'>
        </ix-status-history-chart>

        <div class="status" id="status">等待组件加载...</div>
    </div>

    <script>
        function analyzeAlignment() {
            const chart = document.querySelector('ix-status-history-chart');
            const overlay = document.getElementById('debug-overlay');
            const status = document.getElementById('status');
            const container = document.querySelector('.container');

            if (!chart || !chart.shadowRoot) {
                status.textContent = '错误: 组件未加载或Shadow DOM不存在';
                return;
            }

            const containerRect = container.getBoundingClientRect();
            const xLabels = chart.shadowRoot.querySelectorAll('.x-label');
            const verticalLines = chart.shadowRoot.querySelectorAll('.grid-lines line[x1]');
            const chartSvg = chart.shadowRoot.querySelector('.chart-svg-container');

            if (!chartSvg) {
                status.textContent = '错误: 图表SVG容器未找到';
                return;
            }

            const svgRect = chartSvg.getBoundingClientRect();

            // 清除之前的调试线
            overlay.innerHTML = '';

            let statusText = `标签数量: ${xLabels.length}, 垂直线数量: ${verticalLines.length}\n\n`;

            // 绘制垂直网格线的调试线
            verticalLines.forEach((line, index) => {
                const x1 = parseFloat(line.getAttribute('x1'));
                const actualX = svgRect.left - containerRect.left + x1;

                const gridDebugLine = document.createElement('div');
                gridDebugLine.className = 'debug-line grid-line';
                gridDebugLine.style.left = `${actualX}px`;
                gridDebugLine.title = `Grid line ${index}: x=${x1}`;
                overlay.appendChild(gridDebugLine);

                statusText += `网格线 ${index}: x=${x1}, 实际位置=${actualX.toFixed(1)}\n`;
            });

            // 绘制标签中心的调试线
            xLabels.forEach((label, index) => {
                const labelRect = label.getBoundingClientRect();
                const labelCenter = labelRect.left - containerRect.left + labelRect.width / 2;
                const labelText = label.textContent?.trim();

                const labelDebugLine = document.createElement('div');
                labelDebugLine.className = 'debug-line label-line';
                labelDebugLine.style.left = `${labelCenter}px`;
                labelDebugLine.title = `Label "${labelText}" center`;
                overlay.appendChild(labelDebugLine);

                // 计算与对应网格线的偏移
                if (verticalLines[index]) {
                    const x1 = parseFloat(verticalLines[index].getAttribute('x1'));
                    const gridX = svgRect.left - containerRect.left + x1;
                    const offset = Math.abs(labelCenter - gridX);

                    statusText += `标签 "${labelText}": 中心=${labelCenter.toFixed(1)}, 偏移=${offset.toFixed(1)}px\n`;
                }
            });

            status.textContent = statusText;
        }

        // 等待组件加载
        setTimeout(analyzeAlignment, 2000);

        customElements.whenDefined('ix-status-history-chart').then(() => {
            setTimeout(analyzeAlignment, 1000);
        });
    </script>
</body>
</html>
